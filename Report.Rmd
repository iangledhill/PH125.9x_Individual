---
title: "Individual Learner"
subtitle: "US Domestic Flight Delays"
author: "Ian Gledhill"
date: "03/06/2019"
output:
  pdf_document: default
  html_document:
    df_print: paged
---

```{r setup, include=FALSE, echo=FALSE}
knitr::opts_chunk$set(echo = FALSE)
```

```{r main, code = source("Main.R"), include=FALSE, echo=FALSE}
```

```{r}
library(knitr)
```

\newpage
# Introduction

## Overview

This project will look at the delayed flight data recorded in the US for the 3 months from January to March 2018 and use data analysis to create a model to predict whether a flight would be delayed from its scheduled departure time. The data is provided by the US Department of Transport and covers `r length(levels(active_flights$OP_UNIQUE_CARRIER))` carriers operating from `r length(levels(active_flights$ORIGIN_AIRPORT_ID))` airports.


## Dataset

### Source

The data is provided by:

  https://www.transtats.bts.gov

  BUREAU OF TRANSPORTATION STATISTICS 
  U.S. Department of Transportation 
  1200 New Jersey Avenue, SE 
  Washington, DC 20590 
  855-368-4200 


The page to download the data used in this project can be found here: 

https://www.transtats.bts.gov/Fields.asp?Table_ID=236


### Sample Size for Analysis
The DoT record more than 500,000 domestic flights per months. The period covered by this project contains `r format_number(nrow(active_flights) + nrow(cancelled_flights))` data points. Each data point has `r length(active_flights)` measurements.

### Shape of the Data
The data that the DoT make available falls into the 11 groupings shown below (the number of measurements in each group are shown in brackets). Not all the groupings are relevant to this project, which is only concerned with delayed departures; for example, the arrival performance at the destination airport is not relevant. The groupings that are considered useful are shown in bold.

* **Time Period** (6 catagorical)

* **Airline** (5 catagorial)

* **Origin** (9 catagorical)

* Destination (9 catagorical)

* **Departure Performance** (3 catagorical, 6 continuous)

* Arrival Performance (3 catagorical, 6 continuous)

* **Cancellations and Diversions** (3 catagorical)

* **Flight Summaries** (3 catagorical, 3 continuous )

* **Cause of Delay** (5 catagorical)

* **Gate Returns** (3 continuous)

* Diverted Airport Information (4 x sub-groups reprenting each diversion with 4 catagorical and 3 continuous)

### Overview of the Data

There are `r format_number(nrow(active_flights) + nrow(cancelled_flights))` departures recorded in total for the period covered by the data.
Of these `r format_number(nrow(active_flights))` have recorded departure times, which this report refers to as _active flights_. The other `r format_number(nrow(cancelled_flights))` have no departure recorded, mostly because the flights were cancelled.

Of the _active flights_: 
* `r percent(mean(active_flights$DEP_DELAY < 0))` of active flights departed ahead of their scheduled time 
* `r percent(mean(active_flights$DEP_DELAY == 0))` of active flights departed at their scheduled time 
* `r percent(mean(active_flights$DEP_DELAY > 0))` of active flights departed after their scheduled time 

This project is only considering _delayed_ departures, i.e. where the recorded actual departure time is after the scheduled departure time.

```{r Delay_Duration, echo=FALSE}
active_flights %>%
    filter(DEP_DELAY > 0) %>%
    mutate(DEP_DELAY_LIMIT = ifelse( DEP_DELAY > 180, 180, DEP_DELAY)) %>%
    ggplot(aes(x=DEP_DELAY_LIMIT)) + 
    geom_histogram(bins=30) +
    ggtitle("Flight Delays", subtitle="Delay Duration (> 3 hours shown as 3 hours)") +
    xlab("Delay (in minutes") +
    theme_minimal()
```  

We can see that most flight delays are less than 50 minutes.

```{r Delay_By_TimeSlot, echo=FALSE}
active_flights %>%
    filter(DEP_DELAY > 0) %>%
    ggplot(aes(x=DEP_TIME_BLK)) + 
    geom_histogram(stat="count") +
    ggtitle("Flight Delays", subtitle="Distribution through the day") +
    xlab("Time Slot") +
    theme_minimal()
```

```{r Delay_By_DayOfWeek, echo=FALSE}
active_flights %>%
    group_by(DEP_TIME_BLK) %>%
    summarise(
      n = n(),
      n_delayed = sum(DEP_DELAY > 0),
      delay_rate = n_delayed / n
    ) %>%
    mutate(DEP_TIME_BLK_SHORT = substr(DEP_TIME_BLK,1,2)) %>%
    ggplot(aes(x=DEP_TIME_BLK_SHORT)) + 
    geom_point(aes(y = n), color="blue") +
    geom_point(aes(y=n_delayed), color="red") +
    geom_point(aes(y=delay_rate, size=delay_rate, color=delay_rate)) +
    ggtitle("Flight Delays", subtitle="Distribution by time slot") +
    labs(col="Delay Rate", size="Delay Rate") +
    xlab("Time Slot") +
    ylab("Count") +
    theme_minimal()
```


```{r Delay_By_DayOfWeek2, echo=FALSE}
active_flights %>%
    group_by(DAY_OF_WEEK) %>%
    summarise(
      n = n(),
      n_delayed = sum(DEP_DELAY > 0),
      delay_rate = n_delayed / n
    ) %>%
    ggplot(aes(x=DAY_OF_WEEK)) + 
    geom_point(aes(y = n), color="blue") +
    geom_point(aes(y=n_delayed), color="red") +
    geom_point(aes(y=delay_rate, size=delay_rate, color=delay_rate)) +
    ggtitle("Flight Delays", subtitle="Distribution by Day Of Week") +
    labs(col="Delay Rate", size="Delay Rate") +
    xlab("Day of Week") +
    ylab("Count") +
    theme_minimal()
```


### Training and Test Data Partitions


## Goal

The goal of this project is to create a prediction model that would estimate the probably deviation from the scheduled departure time for any  domestic flight from any US airport covered by the DoT data.



\newpage
# Approach

## Data Cleansing

#### Cancelled Flights
The aircraft will either leave early, leave on time or be delayed. The expected departure time is given by *CRS_DEP_TIME* and the number of minutes relative to this time of the actual departure is given by *DEP_DELAY*. In some case the *DEP_DELAY* will not be available (and be given a value of N/A in the data). This is normally due to the flight being cancelled but can be not available even though the flight is not recorded as being cancelled. 


## Modelling Techniques

The data set is quite large and has many features. This makes it computationally expensive. To aleviate this Principal Component Analysis (PCA) will be used to reduce the number of features.  

An initial attemp to use SVM (_Support Vector Machines_) proved to be too computationally expensive to be useful.
CART (_classification and regression trees_) has been adopted.

After training the model the best CP (_complexity parameter_) was found to be `r train_rpart$bestTune$cp`.

```{r CART_BestFit, echo=FALSE}
rpart.plot(train_rpart$finalModel)
```

```{r CART_BestFit_Rules, echo=FALSE}
rpart.rules(train_rpart$finalModel)
```

\newpage
# Results



\newpage
# Conclusion



\newpage
# Bibliography and References



